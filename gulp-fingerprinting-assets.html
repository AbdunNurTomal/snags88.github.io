<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Gulp: Fingerprinting Assets</title> <meta name="description" content="The modern web browser does a lot of things behind the scenes to improvethe user experience, like caching asset files on your local disk. Inthis way if we ne..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://snags88.github.io/gulp-fingerprinting-assets"> <link rel="alternate" type="application/rss+xml" title="gem install Seiji" href="http://snags88.github.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="no-style primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">Gulp: Fingerprinting Assets</h1> <p class="post-meta"><time datetime="2017-03-28T05:30:00-07:00" itemprop="datePublished">Mar 28, 2017</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <p>The modern web browser does a lot of things behind the scenes to improve the user experience, like caching asset files on your local disk. In this way if we need to load them again, it just reuses those files instead of making a request to the server.</p> <blockquote> <p><em>As developers, we should know about caching because a.) it’s free b.) it makes our sites fast.</em></p> </blockquote> <p>The way that caching client side assets works is pretty simple:</p> <ul> <li>An asset like <code class="highlighter-rouge">myJSFile.js</code> is referenced somewhere on your HTML doc</li> <li>The browser makes a request to get that asset from your server.</li> <li>If the same file name already exists on your local cache, it will reuse that file and avoid making a request to the server.</li> </ul> <p>There are some nuances with the response headers when the asset is served that could prevent caching or set a cache duration. But for now, we’ll ignore those and assume all our assets are getting cached.</p> <p>The common technique for “busting” the cache and forcing the client to retrieve an updated asset is to “fingerprint” our files. As elegantly explained by the <a href="http://guides.rubyonrails.org/asset_pipeline.html#what-is-fingerprinting-and-why-should-i-care-questionmark">Rails Asset Pipeline doc</a>: “Fingerprinting is a technique that makes the name of a file dependent on the contents of the file. When the file contents change, the filename is also changed. For content that is static or infrequently changed, this provides an easy way to tell whether two versions of a file are identical, even across different servers or deployment dates.”</p> <p>With those things in mind, let’s dive into the meat of this post.</p> <h2 id="background">Background</h2> <p>The problem that we encountered with Learn.co is that some of our SVGs were not appearing when we deployed new SVGs until you cleared your cache (or do a “hard” refresh).</p> <p>After digging into it a bit, the problem is that the client side templates were always referencing <code class="highlighter-rouge">/assets/sprite.svg</code> so when we added new SVGs to our sprite file, the browser was using the old cached version of the file.</p> <p>This wasn’t a problem with server-side rendered templates because Rails auto-magically takes care of fingerprinting the asset files for us. However, we have a pretty custom build process using Gulp for our client-side code and it gets compiled before running through the asset pipeline.</p> <p>Knowing the above, I came up with a solution to fingerprint files in our Gulp build process.</p> <h2 id="implementation">Implementation</h2> <p>The way I wanted to approach this was to fingerprint our assets, then swap out references to it like good ol’ Indiana Jones. Here are the tools I used:</p> <ul> <li><a href="https://github.com/sindresorhus/gulp-rev"><code class="highlighter-rouge">gulp-rev</code></a> will take in files and output fingerprinted versions + a manifest JSON file that maps the old filename to the new filename.</li> <li><a href="https://github.com/callumacrae/rev-del"><code class="highlighter-rouge">rev-del</code></a> will take in old and new manifest JSON files and delete fingerprinted files that are no longer being used.</li> <li><a href="https://github.com/vincentmac/gulp-fingerprint"><code class="highlighter-rouge">gulp-fingerprint</code></a> will take a manifest JSON file and replace any references to the old filenames with the new filenames.</li> </ul> <p>I definitely ran into a few tricky parts so I’ll detail each step here.</p> <h3 id="fingerprint-our-files">Fingerprint our files</h3> <p>In our <code class="highlighter-rouge">gulpfile.js</code> we’re going to create a task to fingerprint our files. For simplicity sake, I’ll hardcode the configurations.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// gulpfile.js</span>
<span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp'</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">gutil</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-util'</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">rev</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-rev'</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">revDel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'rev-del'</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">through</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'through2'</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">)</span>
  <span class="p">;</span>

<span class="kd">var</span> <span class="nx">fingerprintConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">src</span><span class="p">:</span> <span class="s1">'./app/assets/images/sprite.svg'</span><span class="p">,</span> <span class="c1">// to fingerprint</span>
  <span class="na">dest</span><span class="p">:</span> <span class="s1">'./app/assets/bin'</span>               <span class="c1">// output folder</span>
<span class="p">}</span>

<span class="c1">// Define gulp task</span>
<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'fingerprint_assets'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">fingerprintAssets</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">fingerprintConfig</span><span class="p">);</span>
<span class="p">})</span>

<span class="c1">// Fingerprinting process</span>
<span class="kd">var</span> <span class="nx">fingerprintAssets</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">run</span><span class="p">:</span> <span class="kd">function</span> <span class="nx">run</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="p">{</span><span class="na">base</span><span class="p">:</span> <span class="s1">'app/assets'</span><span class="p">})</span> <span class="c1">//read files</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rev</span><span class="p">())</span>                                    <span class="c1">//fingerprint files</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">dest</span><span class="p">))</span>                   <span class="c1">//output to dest</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rev</span><span class="p">.</span><span class="nx">manifest</span><span class="p">())</span>                           <span class="c1">//create fingerprint manifest file</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">revDel</span><span class="p">({</span>                                  <span class="c1">//Remove old fingerprinted files</span>
        <span class="na">oldManifest</span><span class="p">:</span> <span class="s1">'./rev-manifest.json'</span><span class="p">,</span>
        <span class="na">dest</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">dest</span>
      <span class="p">}))</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'.'</span><span class="p">))</span>                           <span class="c1">//output manifest to root</span>
      <span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>Not too bad right? Important points are:</p> <ul> <li>To get the file names correctly in accordance with Rails asset pipeline. Your files will appear at <code class="highlighter-rouge">/assets/filename.ext</code>.</li> <li>You must the return the stream in our Gulp task, which forces any dependencies on this task to be sychronous. By doing so, you force your Javascript build to wait for assets to be fingerprinted.</li> <li>Lastly, you’ll want to make sure the keys in the <code class="highlighter-rouge">rev-manifest.json</code> files are correct in accordance with the Rails asset pipeline files. Initially it will look like <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="nt">"images/sprite.svg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"images/sprite-9s3LDioc.svg"</span><span class="w"> </span><span class="p">}</span></code>, but you want to replace your key to be <code class="highlighter-rouge">assets/sprite.svg</code>. To do this I had to add a step to change the manifest stream:</li> </ul> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// gulpfile.js</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="p">{</span><span class="na">base</span><span class="p">:</span> <span class="s1">'app/assets'</span><span class="p">})</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rev</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">dest</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rev</span><span class="p">.</span><span class="nx">manifest</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">//update manifest file to correct keys for Rails pipeline</span>
        <span class="kd">var</span> <span class="nx">originalMap</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">enc</span><span class="p">));</span>

        <span class="kd">var</span> <span class="nx">newMap</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">originalMap</span><span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">mem</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">newFilePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'assets'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span>
          <span class="nx">mem</span><span class="p">[</span><span class="nx">newFilePath</span><span class="p">]</span> <span class="o">=</span> <span class="nx">originalMap</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
          <span class="k">return</span> <span class="nx">mem</span><span class="p">;</span>
        <span class="p">},</span> <span class="p">{})</span>

        <span class="nx">chunk</span><span class="p">.</span><span class="nx">contents</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">newMap</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">'  '</span><span class="p">))</span>
        <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span>
      <span class="p">}))</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">revDel</span><span class="p">({</span>
        <span class="na">oldManifest</span><span class="p">:</span> <span class="s1">'./rev-manifest.json'</span><span class="p">,</span>
        <span class="na">dest</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">dest</span>
      <span class="p">}))</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'.'</span><span class="p">))</span>
      <span class="p">;</span>
    <span class="c1">// ...</span></code></pre></figure> <p>With the above task, we should get our fingerprinted files in <code class="highlighter-rouge">./app/assets/bin/</code> and a manifest file at the root of our project <code class="highlighter-rouge">./rev-manifest.json</code>. Also, anytime we change the file, the old fingerprinted files are removed for us.</p> <h3 id="update-references-to-the-new-file">Update references to the new file</h3> <p>The next step is to use the <code class="highlighter-rouge">./rev-manifest.json</code> file with <code class="highlighter-rouge">gulp-fingerprint</code> to swap out the file references:</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// gulpfile.js</span>
<span class="c1">// omitting the dependencies for brevity</span>

<span class="kd">var</span> <span class="nx">jsBuildConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">src</span><span class="p">:</span> <span class="s1">'./app/assets/javascripts/index.js'</span><span class="p">,</span>
  <span class="na">dest</span><span class="p">:</span> <span class="s1">'./app/assets/javascripts/bin'</span>
<span class="p">}</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'build'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'fingerprint_assets'</span><span class="p">],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">jsBuild</span><span class="p">.</span><span class="nx">bundle</span><span class="p">(</span><span class="nx">jsBuildConfig</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">jsBuild</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">bundle</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bundler</span> <span class="o">=</span> <span class="nx">browserify</span><span class="p">({</span><span class="na">entries</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">src</span><span class="p">});</span> <span class="c1">// Note we're using browserify here.</span>

    <span class="c1">// Do some browserify transforms here</span>
    <span class="nx">bundler</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="s1">'jadeify'</span><span class="p">);</span>
    <span class="nx">bundler</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="s1">'babelify'</span><span class="p">,</span> <span class="p">{</span><span class="na">presets</span><span class="p">:</span> <span class="p">[</span><span class="s1">'es2015'</span><span class="p">,</span> <span class="s1">'react'</span><span class="p">]});</span>

    <span class="c1">//Read manifest to swap file references. Configure fingerprint</span>
    <span class="nx">options</span>
    <span class="kd">var</span> <span class="nx">manifest</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'./rev-manifest.json'</span><span class="p">))</span>
      <span class="p">,</span> <span class="nx">fingerprintOpts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getFingerprintOpts</span><span class="p">(</span><span class="nx">manifest</span><span class="p">)</span>
      <span class="p">;</span>

    <span class="k">return</span> <span class="nx">bundler</span>
      <span class="p">.</span><span class="nx">bundle</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">source</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">file</span><span class="p">)))</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">buffer</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">fingerprint</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span> <span class="nx">fingerprintOpts</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">dest</span><span class="p">))</span>
      <span class="p">;</span>
  <span class="p">},</span>

  <span class="na">_getFingerprintOpts</span><span class="p">:</span> <span class="kd">function</span> <span class="nx">_getFingerprintOpts</span><span class="p">(</span><span class="nx">manifest</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// setup regex to match all manifest keys</span>
    <span class="kd">var</span> <span class="nx">regexString</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">manifest</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">'('</span> <span class="o">+</span> <span class="nx">file</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="s1">'\\/'</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="s1">'\\.'</span><span class="p">)</span> <span class="o">+</span><span class="s1">')'</span> <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'|'</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">regex</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">regexString</span><span class="p">)</span>
      <span class="p">;</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="na">regex</span><span class="p">:</span> <span class="nx">regex</span><span class="p">,</span>
      <span class="na">prefix</span><span class="p">:</span> <span class="s1">'assets/'</span><span class="p">,</span>
      <span class="na">strip</span><span class="p">:</span> <span class="s1">'images/'</span><span class="p">,</span>
      <span class="na">verbose</span><span class="p">:</span> <span class="kc">false</span> <span class="c1">// set this to true to debug</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span></code></pre></figure> <p>There’s a lot of code there, so here’s a quick explanation:</p> <ol> <li>Set up configurations for the build task.</li> <li>Set up the <code class="highlighter-rouge">'build'</code> task with a dependency on the <code class="highlighter-rouge">fingerprint_assets</code> task.</li> <li>Setup Browserify and bundle.</li> <li>In the stream, use <code class="highlighter-rouge">gulp-buffer</code> to convert the stream to a buffer and pipe it into <code class="highlighter-rouge">gulp-fingerprint</code> to replace all references to <code class="highlighter-rouge">assets/sprite.svg</code> with the fingerprinted file reference. <ul> <li>Note the options uses the manifest to create a regex to match all occurances in our file.</li> </ul> </li> </ol> <h2 id="results">Results</h2> <p>To confirm that everything went well, we can open up our file in <code class="highlighter-rouge">./app/assets/javascripts/bin/index.js</code> and make sure all the file references are correct.</p> <p>Now when you update the <code class="highlighter-rouge">sprite.svg</code> file, the fingerprinted filename should change and bust any cache on the clients.</p> <h2 id="next-step">Next step</h2> <p>A nice thing to do for our build process is to omit the fingerprinting &amp; replacing file references in our development environment. You can do this by looking at <code class="highlighter-rouge">process.env.NODE_ENV</code> in our <code class="highlighter-rouge">gulpfile.js</code> to conditionally run the fingerpriting steps.</p> <p>That’s all I got for now. Till next time, happy coding!</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2018 All rights reserved. Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/nandomoreirame/dotX" target="_blank">dotX</a> theme.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html>