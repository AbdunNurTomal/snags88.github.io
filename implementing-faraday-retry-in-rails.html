<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Implementing Faraday Retry in Rails</title> <meta name="description" content="Yesterday, I had the chance to tackle an interesting problem at work. Weuse a lot of 3rd party APIs ranging from Slack, Github, to Ambassador and one potenti..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://snags88.github.io/implementing-faraday-retry-in-rails"> <link rel="alternate" type="application/rss+xml" title="gem install Seiji" href="http://snags88.github.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="no-style primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">Implementing Faraday Retry in Rails</h1> <p class="post-meta"><time datetime="2016-06-13T05:30:00-07:00" itemprop="datePublished">Jun 13, 2016</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <p>Yesterday, I had the chance to tackle an interesting problem at work. We use a lot of 3rd party APIs ranging from <a href="https://slack.com/">Slack</a>, <a href="https://github.com/">Github</a>, to <a href="https://www.getambassador.com/">Ambassador</a> and one potential issue is that sometimes these services timeout for whatever reason (API is down or slow).</p> <p>A common way to address <code class="highlighter-rouge">Timeout</code> errors is to have a retry system with an exponential backoff. Simply put, if you disconnect your internet while you’re on your Gmail, it will have a message that says <strong>Reconnecting in 1s…</strong> and if it fails to reconnect, the new message will say <strong>Reconnecting in 2s…</strong>, <strong>Reconnecting in 4s…</strong>, <strong>Reconnecting in 8s…</strong>. The algorithm of the backoff depends on the system, but you get the idea.</p> <p>Most of our API wrappers use <a href="https://github.com/lostisland/faraday">Faraday</a> to make HTTP requests. One benefit to using Faraday is that it uses middleware and luckily Faraday already has a built in retry middleware. You can see it in their source code <a href="https://github.com/lostisland/faraday/blob/master/lib/faraday/request/retry.rb">here</a>. We just need to add it to our list of middleware. For more info about middleware, here are some good resources: <a href="http://railscasts.com/episodes/151-rack-middleware?view=asciicast">Railscast</a>, <a href="https://www.amberbit.com/blog/2011/07/13/introduction-to-rack-middleware/">Blog</a>, <a href="https://www.mobomo.com/2012/3/faraday-one-http-client-to-rule-them-all/">Another Blog</a>.</p> <p>For this particular post, I’m going to use an example with the <a href="https://github.com/octokit/octokit.rb">Octokit</a> gem, a wrapper to the Github API. Octokit uses Sawyer/Faraday to make HTTP requests so we just need to override the default Octokit middleware as seen in the source code <a href="https://github.com/octokit/octokit.rb/blob/22846aec1140dac89945c8908ce62777bec37271/lib/octokit/default.rb#L26-L32">here</a>. If you are using a Rails app like me, then you just need to stick the following code in an initializer file so that the Octokit defaults are overridden before any instances are created during code execution.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Octokit</span><span class="p">.</span><span class="nf">middleware</span> <span class="o">=</span> <span class="no">Faraday</span><span class="o">::</span><span class="no">RackBuilder</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">builder</span><span class="o">|</span>
  <span class="c1"># add the faraday retry middleware</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">use</span> <span class="no">Faraday</span><span class="o">::</span><span class="no">Request</span><span class="o">::</span><span class="no">Retry</span>

  <span class="c1"># add the default Octokit middlewares</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">use</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">FollowRedirects</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">use</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Response</span><span class="o">::</span><span class="no">RaiseError</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">use</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Response</span><span class="o">::</span><span class="no">FeedParser</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">adapter</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">default_adapter</span>
<span class="k">end</span></code></pre></figure> <p>Note that in the above example, I use the <a href="https://github.com/lostisland/faraday/blob/master/lib/faraday/request/retry.rb#L74-L96">default retry settings</a>. You will be able to set your own configurations by following the code sample <a href="https://github.com/lostisland/faraday/blob/master/lib/faraday/request/retry.rb#L11-L16">here</a>.</p> <p>Sweet, now that we have that middleware in place, how do we know this is actually working?</p> <p><strong>By writing a spec of course.</strong></p> <p>The tools we’ll be using are <a href="http://rspec.info/">Rspec</a> and <a href="https://github.com/bblimke/webmock">Webmock</a>. The spec will be pretty straight forward: we’ll use webmock to throw a <code class="highlighter-rouge">Timeout</code> error on the initial API request and a legit response on the second request. The expected behavior is that the webmock stub is requested exactly twice since that is the default number of retries from the Faraday middleware.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">it</span> <span class="s1">'retries on a timeout exception'</span> <span class="k">do</span>
  <span class="c1"># mock out the api request with responses</span>
  <span class="n">stubbed_request</span> <span class="o">=</span> <span class="n">stub_request</span><span class="p">(</span><span class="ss">:any</span><span class="p">,</span> <span class="sr">/github/</span><span class="p">).</span>
    <span class="nf">to_timeout</span><span class="p">.</span><span class="nf">then</span><span class="p">.</span>
    <span class="nf">to_return</span><span class="p">({</span><span class="ss">body: </span><span class="s1">'abc'</span><span class="p">})</span>

  <span class="c1"># OCTOKIT here is an authenticated Octokit client</span>
  <span class="no">OCTOKIT</span><span class="p">.</span><span class="nf">user</span>

  <span class="c1"># Provide expected behavior</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">stubbed_request</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_been_requested</span><span class="p">.</span><span class="nf">twice</span>
<span class="k">end</span></code></pre></figure> <p>This implementation can be applied to other API wrappers using Faraday. Surprisingly, I couldn’t find a lot of resources online about the Faraday retry middleware so hopefully this helps someone in the future.</p> <p>Also, big kudos to <a href="https://stackoverflow.com/questions/25552239/webmock-simulate-failing-api-no-internet-timeout">this SO post</a> for providing a starting point and my co-worker Spencer for guidance on the implementation.</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2018 All rights reserved. Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/nandomoreirame/dotX" target="_blank">dotX</a> theme.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html>