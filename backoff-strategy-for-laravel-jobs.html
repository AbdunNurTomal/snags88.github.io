<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Backoff Strategy for Laravel Jobs</title> <meta name="description" content="What are jobs?Background jobs are key to any seemingly fast application. They’rereally useful for running tasks asynchronously so that your user isn’twaiting..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://snags88.github.io/backoff-strategy-for-laravel-jobs"> <link rel="alternate" type="application/rss+xml" title="gem install Seiji" href="http://snags88.github.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="no-style primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">Backoff Strategy for Laravel Jobs</h1> <p class="post-meta"><time datetime="2018-07-27T18:51:00-07:00" itemprop="datePublished">Jul 27, 2018</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <h2 id="what-are-jobs">What are jobs?</h2> <p>Background jobs are key to any seemingly fast application. They’re really useful for running tasks asynchronously so that your user isn’t waiting for some code to run that doesn’t directly impact their experience in the app.</p> <p>One small example of using a background job is when a user logs in to our app, we want to update their <code class="highlighter-rouge">last_logged_in_at</code> timestamp in our database. From the user’s perspective, do they really care about this timestamp? Nope, not really. This would be a perfect time to use a background job to do a database write operation.</p> <h2 id="how-do-jobs-work">How do jobs work?</h2> <p>When these jobs are initially fired off, they are put onto the application’s queue. The queue could be anything as long as it tracks the jobs’ information. Some are backed by the application’s database, Redis, RabbitMQ, etc.</p> <p>Once the jobs are on the queue, there is a worker process that will grab jobs off of the queue and execute the job’s code.</p> <h2 id="configuring-jobs-in-laravel">Configuring jobs in Laravel</h2> <p>Laravel provides background jobs for us out of the box. All you need to do is create a plain old class, add some traits, implement an interface, and dispatch it from your main app code.</p> <p>For more information about managing jobs in Laravel, take a look at their <a href="https://laravel.com/docs/5.6/queues#creating-jobs" target="_blank">detailed documentation</a>.</p> <h2 id="backoff-strategy">Backoff strategy?</h2> <p>In modern applications when an issue occurs, there is an attempt to retry the block of code that caused the issue. For example, if you are on GMail and you lose internet connection, the website will attempt to reconnect to the Google servers. What you might notice is that on the first try, it will attempt to reconnect immediately. Then it’ll wait a few seconds and try again. Then wait 10-15 second and try again. Then another 30-40 second wait, etc. What you experienced is called a backoff strategy for reattempting a failed task.</p> <p>As you can imagine, with queued jobs, it would be great to adopt this strategy especially for jobs that deal with third-party APIs. If the third-party is down, then it may take some time for it to come back up so it’s beneficial to have a backoff strategy.</p> <p>Sadly, Laravel does not have a backoff strategy built into their jobs. However, with the failed job handling it exposes to us, we can write our own retriable job easily. The particular backoff strategy we’ll implement is called an exponential backoff strategy because we increase our backoff exponentially (i.e. 2, 4, 8, 16, 32, etc.).</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">RetriableJob</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$tries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// override default and make sure we don't requeue automatically
</span>
    <span class="k">public</span> <span class="nv">$currentRetryCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$maxRetries</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="c1">// 3, 9, 27, 81, 243, 729, 2187 seconds
</span>
    <span class="k">public</span> <span class="nv">$backoffFactor</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">failed</span><span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">currentRetryCount</span> <span class="o">&lt;=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">maxRetries</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">delay</span><span class="p">(</span><span class="nx">now</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addSeconds</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">backoffFactor</span> <span class="o">**</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">currentRetryCount</span><span class="p">));</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">currentRetryCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">return</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>The implementation above uses the <code class="highlighter-rouge">failed</code> hook to update the job’s traits <code class="highlighter-rouge">delay</code> and <code class="highlighter-rouge">currentRetryCount</code>. Afterwards, it redispatches the job onto the queue.</p> <p>To use this, you just need to inherit the abstract class to your job:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyJob</span> <span class="k">extends</span> <span class="nx">RetriableJob</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Do my job
</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <h2 id="future-improvements">Future Improvements</h2> <p>This isn’t the cleanest implementation since we try a job once, and then we just requeue it. To do this correctly, we actually need to dive into the framework itself and update the code. Ideally the code would be changed so that when the worker processes the job and it has multiple <code class="highlighter-rouge">tries</code>, it would allow use to specify a <code class="highlighter-rouge">delay</code> time before we release it back into the queue.</p> <p>In any case, the implementation is easy to understand and shouldn’t have any performance impact on the worker queue. I couldn’t really find a good example of this online when I needed to implement it, so hopefully this helps someone in the future.</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2018 All rights reserved. Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/nandomoreirame/dotX" target="_blank">dotX</a> theme.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html>