<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Authorization with Pundit</title> <meta name="description" content="In a Rails app, authorization can be implemented in many ways. You canroll out your own simple authorization by assigning a role numberwhere role = 1 means r..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://snags88.github.io/authorization-with-pundit"> <link rel="alternate" type="application/rss+xml" title="gem install Seiji" href="http://snags88.github.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="no-style primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">Authorization with Pundit</h1> <p class="post-meta"><time datetime="2016-07-02T05:30:00-07:00" itemprop="datePublished">Jul 2, 2016</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <p>In a Rails app, authorization can be implemented in many ways. You can roll out your own simple authorization by assigning a <code class="highlighter-rouge">role</code> number where <code class="highlighter-rouge">role = 1</code> means regular user, <code class="highlighter-rouge">role = 3</code> means admin, etc.</p> <p>The above implementation was how the Learn app originally had authorization, but since then, our product has grown a lot and we switched to using a gem called <a href="https://github.com/elabs/pundit"><strong>Pundit</strong></a>.</p> <p>A few nice things about Pundit is that it’s very light weight and uses plain old Ruby objects (PORO). Beyond that, how you implement the authorization is pretty flexible. Pundit also comes with built in helper methods so you can authorize your users easily.</p> <h2 id="configuring-pundit">Configuring Pundit</h2> <p>The first step is to include the <code class="highlighter-rouge">pundit</code> gem in your <code class="highlighter-rouge">Gemfile</code>. Afterwards, you need to include the <code class="highlighter-rouge">Pundit</code> module in your <code class="highlighter-rouge">ApplicationController</code> so all that authorization goodness is available in your app.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">Pundit</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span></code></pre></figure> <p>Next, we need to setup a “policies” folder so go ahead and create one in <code class="highlighter-rouge">app/policies</code>. It really doesn’t matter where we put the policies, but this is the place that’s suggested. More importantly, what are policies…</p> <h2 id="policy-objects">Policy Objects</h2> <p><code class="highlighter-rouge">Pundit</code> uses what is called “Policy Objects” to determine a particular user’s authorization on the specific object. For instance, let’s say we have a resource in our app called <code class="highlighter-rouge">Organization</code>. In order to check a user’s authorization for an organization, pundit will look for an <code class="highlighter-rouge">OrganizationPolicy</code>.</p> <p>So you can imagine the <code class="highlighter-rouge">OrganizationPolicy</code> looks something like this:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">OrganizationPolicy</span>
  <span class="kp">attr_reader</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:organization</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">organization</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="vi">@organization</span> <span class="o">=</span> <span class="n">organization</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show?</span>
    <span class="c1">#=&gt; some code here to determine if a user can see an organization.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>Like I mentioned earlier, this is a PORO and doesn’t depend on any inheritance. But you know what might be good is if we create an <code class="highlighter-rouge">ApplicationPolicy</code> that takes care of some of the boilerplate stuff like the <code class="highlighter-rouge">initialize</code> method. That way all of our policy objects can inherit from it:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationPolicy</span>
  <span class="kp">attr_reader</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:record</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="vi">@record</span> <span class="o">=</span> <span class="n">record</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">OrganizationPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>
  <span class="k">def</span> <span class="nf">show?</span>
    <span class="c1">#=&gt; some code here to determine if a user can see an organization.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <h2 id="determining-authorization">Determining Authorization</h2> <p>I also mentioned earlier that you can implement your authorization logic how you see fit. So there’s no hard fast rule on the implementation, but to give you an idea, there might be a polymorphic table in our database that determines the authorization level. For instance you might have something like:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">org</span> <span class="o">=</span> <span class="no">Organization</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'My Organization'</span><span class="p">)</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">username: </span><span class="s1">'TestUser'</span><span class="p">)</span>
<span class="n">role</span> <span class="o">=</span> <span class="no">Role</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'admin'</span><span class="p">)</span>

<span class="no">UserRole</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">roleable: </span><span class="n">org</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">role: </span><span class="n">role</span><span class="p">)</span></code></pre></figure> <p>Don’t worry too much about where all those <code class="highlighter-rouge">ActiveRecord</code> models came from. What we really care about is that there is now a <code class="highlighter-rouge">UserRole</code> that ties the user, organization, and a role. Now for our <code class="highlighter-rouge">OrganizationPolicy</code> we can do something like:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">OrganizationPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>
  <span class="k">def</span> <span class="nf">show?</span>
    <span class="n">has_role_for_record?</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">has_role_for_record?</span><span class="p">(</span><span class="n">role_name</span><span class="p">)</span>
    <span class="o">!!</span><span class="no">UserRole</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">user: </span><span class="n">user</span><span class="p">,</span> <span class="ss">roleable: </span><span class="n">record</span><span class="p">,</span> <span class="ss">role:
    </span><span class="no">Role</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">name: </span><span class="n">role_name</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>Now, the <code class="highlighter-rouge">#show?</code> method returns a boolean value based on if the user has the proper record in the <code class="highlighter-rouge">UserRole</code> model.</p> <h2 id="authorizing-a-user">Authorizing a User</h2> <p>Ok we set up all the policy objects and the proper authorization logic. Now how do we authorize a particular user?</p> <p>At the core of it, you actually don’t even need the helper methods provided by <code class="highlighter-rouge">Pundit</code>. In your controller, you can easily do:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">OrganizationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="c1"># current_user is logged in user</span>
    <span class="n">organization</span> <span class="o">=</span> <span class="no">Organization</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'My Organization'</span><span class="p">)</span>

    <span class="k">unless</span> <span class="no">OrganizationPolicy</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">organization</span><span class="p">).</span><span class="nf">show?</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">end</span>

    <span class="c1"># show the organization page.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>But that’s meh. You can use a helper method called ‘authorize’ provided by <code class="highlighter-rouge">Pundit</code> to make it more sexy. <code class="highlighter-rouge">authorize</code> takes in the record object you want to authorize and an optional method name that should be called on the policy object:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">OrganizationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="c1"># current_user is logged in user</span>
    <span class="n">organization</span> <span class="o">=</span> <span class="no">Organization</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'My Organization'</span><span class="p">)</span>

    <span class="n">authorize</span> <span class="n">organization</span><span class="p">,</span> <span class="ss">:show?</span>

    <span class="c1"># show the organization page.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>If the user is not authorized, <code class="highlighter-rouge">Pundit</code> will raise <code class="highlighter-rouge">Pundit::NotAuthorizedError</code> that you can rescue in your <code class="highlighter-rouge">ApplicationController</code>. Another thing that the <code class="highlighter-rouge">authorize</code> method does is that if you don’t pass in the method name, it infers it by the controller action name and tacking on a question mark on it.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">OrganizationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="c1"># current_user is logged in user</span>
    <span class="n">organization</span> <span class="o">=</span> <span class="no">Organization</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'My Organization'</span><span class="p">)</span>

    <span class="n">authorize</span> <span class="n">organization</span>
    <span class="c1"># this is running OrganizationPolicy.new(current_user, organization).show?</span>
    <span class="c1"># because we're in the `show` controller action.</span>

    <span class="c1"># show the organization page.</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>What’s cool is that we can use the policy objects without the helper methods so they can be used to authorize users in our API endpoints, our serialized objects, and so on.</p> <p>There’s much more you can do with Pundit like change the scope for a resource based on the user’s authorization, custom error messages, headless policy objects, etc. I highly recommend checking out <a href="https://www.varvet.com/blog/simple-authorization-in-ruby-on-rails-apps/">this blog post</a>, written by one of team members behind <code class="highlighter-rouge">Pundit</code>.</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2018 All rights reserved. Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/nandomoreirame/dotX" target="_blank">dotX</a> theme.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html>