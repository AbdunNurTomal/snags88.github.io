<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>The Prototype Pattern in Laravel</title> <meta name="description" content="I‚Äôm going to be talking about another creational pattern called theprototype pattern today. This should be pretty straight forward toimplement in a lot of hi..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://snags88.github.io/prototype-pattern-in-laravel"> <link rel="alternate" type="application/rss+xml" title="gem install Seiji" href="http://snags88.github.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="no-style primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">The Prototype Pattern in Laravel</h1> <p class="post-meta"><time datetime="2018-05-16T17:51:00-07:00" itemprop="datePublished">May 16, 2018</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <p>I‚Äôm going to be talking about another creational pattern called the <strong>prototype pattern</strong> today. This should be pretty straight forward to implement in a lot of high-level languages and we‚Äôll take a look at a common place we use it in Laravel.</p> <h2 id="prototype-pattern">Prototype Pattern</h2> <p>The prototype pattern is one of the more simple ones to understand. In this creational pattern, we create a new object by copying an existing object. Wow, that simple?! Yes. That simple.</p> <p>PHP provides us a nice tool to easily copy an object too! The <code class="highlighter-rouge">clone</code> keyword will call the magic function <code class="highlighter-rouge">__clone</code> on an object and return a copy of the object.</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Object</span><span class="p">;</span>
<span class="nv">$obj2</span> <span class="o">=</span> <span class="nv">$obj</span><span class="p">;</span>
<span class="nv">$obj3</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$obj</span><span class="p">;</span>

<span class="sd">/** returns true */</span>
<span class="nv">$obj</span> <span class="o">===</span> <span class="nv">$obj2</span><span class="p">;</span>
<span class="sd">/** returns false */</span>
<span class="nv">$obj</span> <span class="o">===</span> <span class="nv">$obj3</span><span class="p">;</span></code></pre></figure> <p>Interestingly, we don‚Äôt ever need to implement the <code class="highlighter-rouge">__clone</code> function if we just want the default behavior. However, there are times where you might want to implement custom behavior.</p> <p>One of those times is if you want to deep clone an object. By default, PHP will only create a copy of the top level object and if the object has attributes referencing other objects, we‚Äôll just keep a reference to them in our new object. That‚Äôs commonly known as shallow copying. In deep cloning, not only do we want a copy of the original object, but we also want to get copies of all of its attributes. In order to get the deep cloning behavior, we‚Äôll need to override the default behavior like this:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">TestObject</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectAttribute</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OtherObject</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="nf">__clone</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectAttribute</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectAttribute</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>Yes, we just used <code class="highlighter-rouge">clone</code> to implement deep cloning.</p> <p>No, that‚Äôs not cheating. I think‚Ä¶ üòÖ</p> <h2 id="prototype-pattern-in-the-wild-">Prototype Pattern in the Wild üïµÔ∏è</h2> <p>Since cloning objects is not a common interaction with the Laravel framework, we‚Äôll need to dig a little big deeper in the code to see this pattern in the wild.</p> <p>One of the most common places where we see cloning in the Laravel framework is around dispatching events and jobs in queues. It seems like when we queue up a job or event, we need to process any arguments passed to the job/event. Since those arguments could be reused further down in the code execution, it‚Äôs much safer for the framework to clone the argument and mutate the cloned object rather than the original (immutability anyone?).</p> <p>Here‚Äôs some example code from the <a href="https://github.com/laravel/framework/blob/9cf82b9fa7edf5a66a78e69c91abb685f13ed4a1/src/Illuminate/Events/Dispatcher.php" target="_blank"><code class="highlighter-rouge">Illumiate\Events\Dispatcher</code></a> class:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="nf">createQueuedHandlerCallable</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$method</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">return</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$method</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$arguments</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$a</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nb">is_object</span><span class="p">(</span><span class="nv">$a</span><span class="p">)</span> <span class="o">?</span> <span class="k">clone</span> <span class="nv">$a</span> <span class="o">:</span> <span class="nv">$a</span><span class="p">;</span>
          <span class="p">},</span> <span class="nb">func_get_args</span><span class="p">());</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handlerWantsToBeQueued</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">))</span> <span class="p">{</span>
              <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">queueHandler</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">};</span>
  <span class="p">}</span></code></pre></figure> <p>Wow do I see some object arguments being cloned before we pass it along to the queue handler? üëÄ</p> <h3 id="another-example-in-the-wild">Another example in the wild</h3> <p>Another small example I can give is in the commonly used DateTime library called <a href="https://carbon.nesbot.com/docs/">Carbon</a>. Carbon objects are mutable so there are times when you do some calculation based on a date. But in order to do the calculation, you add some date to the original. Well now you‚Äôve mutated the original date. To get around that, you need to <code class="highlighter-rouge">clone</code> the Carbon object. Carbon exposes an API called <code class="highlighter-rouge">copy()</code> to create clones of the Carbon object. To see the implementation of <code class="highlighter-rouge">copy()</code> see <a href="https://github.com/briannesbitt/Carbon/blob/b4d5ba6a2222cd80af1d51694015628bf0f7fed0/src/Carbon/Carbon.php#L937-L945">this link</a>. This code example is straight from their docs:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$dt</span> <span class="o">=</span> <span class="nx">Carbon</span><span class="o">::</span><span class="na">now</span><span class="p">();</span>
<span class="k">echo</span> <span class="nv">$dt</span><span class="o">-&gt;</span><span class="na">diffInYears</span><span class="p">(</span><span class="nv">$dt</span><span class="o">-&gt;</span><span class="na">copy</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addYear</span><span class="p">());</span>

<span class="sd">/** $dt was unchanged and still holds the value of Carbon:now() */</span></code></pre></figure> <p>Well I went into a bit of a rabbit hole of learning how <code class="highlighter-rouge">clone</code> works in PHP and digging around the Laravel framework code. Hopefully you learned about the Prototype pattern and its usage. Cloning objects encourages immutable programming and may lead to avoiding some head-scratching bugs (speaking from personal experience‚Ä¶ looking at you Moment.js üòë). Well thanks for reading and as always, happy coding!</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2018 All rights reserved. Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/nandomoreirame/dotX" target="_blank">dotX</a> theme.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html>