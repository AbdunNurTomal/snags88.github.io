<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>The Proxy Pattern in Laravel</title> <meta name="description" content="Proxy is one of those words that makes you sound technically smart andit‚Äôs seen an increase in usage over the last 20 yearsaccording to Google Books Ngram Vi..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://snags88.github.io/proxy-pattern-in-laravel"> <link rel="alternate" type="application/rss+xml" title="gem install Seiji" href="http://snags88.github.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="no-style primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">The Proxy Pattern in Laravel</h1> <p class="post-meta"><time datetime="2018-06-04T18:51:00-07:00" itemprop="datePublished">Jun 4, 2018</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <p>Proxy is one of those words that makes you sound technically smart and it‚Äôs seen an increase in usage over the last 20 years according to <a href="https://books.google.com/ngrams/graph?content=proxy&amp;case_insensitive=on&amp;year_start=1940&amp;year_end=2018&amp;corpus=15&amp;smoothing=7&amp;share=&amp;direct_url=t4%3B%2Cproxy%3B%2Cc0%3B%2Cs0%3B%3Bproxy%3B%2Cc0%3B%3BProxy%3B%2Cc0%3B%3BPROXY%3B%2Cc0#t4%3B%2Cproxy%3B%2Cc0%3B%2Cs0%3B%3Bproxy%3B%2Cc1%3B%3BProxy%3B%2Cc0%3B%3BPROXY%3B%2Cc0" target="_blank">Google Books Ngram Viewer</a>.</p> <p>Well what does proxy even mean? Lets take a look in more detail.</p> <h2 id="proxy-pattern">Proxy Pattern</h2> <p>The word <em>proxy</em> often means something that replaces something else and behaves similar to the original object. An example of a proxy is when you give the authority to someone to vote on your behalf; it‚Äôs called proxy voting.</p> <p>The proxy pattern in OOP follows a similar concept in that a proxy object stands in place of a real object. That proxy object generally forwards the instuctions on to the real object, but could add additional functionality as needed.</p> <p>The simplest implementation of a proxy object just uses the magic <code class="highlighter-rouge">__call</code> function to dynamically pass along missing methods to the real object:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Proxy</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nv">$obj</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$obj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">obj</span> <span class="o">=</span> <span class="nv">$obj</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="nf">__call</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">obj</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$method</span><span class="p">}(</span><span class="o">...</span><span class="nv">$parameters</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>Well that‚Äôs easy enough in PHP. Gotta love that syntactic sugar.</p> <h2 id="proxy-pattern-in-the-wild-">Proxy Pattern in the Wild üïµÔ∏è</h2> <p>There are various uses for the proxy pattern. People give examples of lazy loading files to authorizing method calls in proxy objects. Interestingly, I found a place in the Laravel framework that uses the proxy pattern for neither of these purposes.</p> <p>Remember that time Taylor Otwell wrote about the <code class="highlighter-rouge">tap</code> function that was inspired by the same named method in Ruby? Well <a href="https://medium.com/@taylorotwell/tap-tap-tap-1fc6fc1f93a6" target="_blank">here</a> is his original post. In it, he describes two ways to use the <code class="highlighter-rouge">tap</code> helper function. The first way has 2 arguments:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">tap</span><span class="p">(</span><span class="nv">$object</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$object</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$object</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
<span class="p">});</span></code></pre></figure> <p>The second passes along only 1 argument, then chains a method, and he claims that it returns the original object:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">return</span> <span class="nx">tap</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span>
    <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="s1">'age'</span> <span class="o">=&gt;</span> <span class="nv">$age</span><span class="p">,</span>
<span class="p">]);</span></code></pre></figure> <p>I was digging around and found where the <code class="highlighter-rouge">tap</code> helper function is defined and this is what the code looks like:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">function_exists</span><span class="p">(</span><span class="s1">'tap'</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Call the given Closure with the given value then return the value.
</span>
    <span class="k">function</span> <span class="nf">tap</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nv">$callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$callback</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">HigherOrderTapProxy</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$callback</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>So the <code class="highlighter-rouge">if</code> block handles when it‚Äôs 1 argument and the remaining code handles when there‚Äôs 2 arguments. Interesting. So what is this <code class="highlighter-rouge">HigherOrderTapProxy</code> that gets returned instead of the original object? Let‚Äôs take a look:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">Illuminate\Support</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">HigherOrderTapProxy</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$target</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$target</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span> <span class="o">=</span> <span class="nv">$target</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__call</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$method</span><span class="p">}(</span><span class="o">...</span><span class="nv">$parameters</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>Ahh I see. So this proxy object just intercepts the method call on the object, calls the method with the parameters, but ignores the return value of that method call, and then always returns the ‚Äútarget‚Äù <em>aka</em> the original object.</p> <p>BAM proxy pattern in real life. Definitely did not think I would find one in Laravel that would be easy to understand, but there you have it! Until next time, happy coding!</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2018 All rights reserved. Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/nandomoreirame/dotX" target="_blank">dotX</a> theme.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html>