<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>The Factory Pattern in Laravel</title> <meta name="description" content="I took a little break this past week, but back on it for the lastcreational pattern. Well, there‚Äôs technically two more, but they‚Äôre verysimilar so I‚Äôm going..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://snags88.github.io/factory-pattern-in-laravel"> <link rel="alternate" type="application/rss+xml" title="gem install Seiji" href="http://snags88.github.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="no-style primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">The Factory Pattern in Laravel</h1> <p class="post-meta"><time datetime="2018-05-25T18:51:00-07:00" itemprop="datePublished">May 25, 2018</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <p>I took a little break this past week, but back on it for the last creational pattern. Well, there‚Äôs technically two more, but they‚Äôre very similar so I‚Äôm going to combine them into one post.</p> <h2 id="factory-pattern">Factory Pattern</h2> <p>The factory pattern and the abstract factory patterns are similar in that they create objects like a factory by exposing some kind of interface to the outside world like <code class="highlighter-rouge">createXYZ</code>.</p> <p>Here is a short example:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">PhoneFactory</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nx">createPhone</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">\Phone</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$phoneFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PhoneFactory</span><span class="p">();</span>
<span class="nv">$phoneA</span> <span class="o">=</span> <span class="nv">$phoneFactory</span><span class="o">-&gt;</span><span class="na">createPhone</span><span class="p">();</span>
<span class="nv">$phoneB</span> <span class="o">=</span> <span class="nv">$phoneFactory</span><span class="o">-&gt;</span><span class="na">createPhone</span><span class="p">();</span></code></pre></figure> <h2 id="abstract-factory-pattern">Abstract Factory Pattern</h2> <p>The main difference between the factory and abstract factory is that the abstract factory pattern is used as a contract to produce objects of a similar group. So for instance:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">PhoneFactory</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nx">createPhone</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">AndroidFactory</span> <span class="k">implements</span> <span class="nx">PhoneFactory</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nx">createPhone</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">\AndroidPhone</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">IPhoneFactory</span> <span class="k">implements</span> <span class="nx">PhoneFactory</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nx">createPhone</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">\IPhone</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">wantsIPhone</span><span class="p">())</span> <span class="p">{</span>
  <span class="nv">$factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IPhoneFactory</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nv">$factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AndroidFactory</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$phone</span> <span class="o">=</span> <span class="nx">factory</span><span class="o">-&gt;</span><span class="na">createPhone</span><span class="p">();</span></code></pre></figure> <p>The key with the abstract factory pattern is that the outside world doesn‚Äôt care which factory is being used as long as it inherits or implements the interface of the abstract factory.</p> <h2 id="factory-pattern-in-the-wild-">Factory Pattern in the Wild üïµÔ∏è</h2> <p>In the world of Laravel, we use the <code class="highlighter-rouge">factory</code> helper function to create Eloquent models in our tests. The factory helper is used like this <code class="highlighter-rouge">$user = factory(\App\Models\User::class)-&gt;create();</code>.</p> <p>I dug into the source code a little bit and found that under the hood, it uses an object called <code class="highlighter-rouge">EloquentFactory</code>.</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">factory</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nv">$factory</span> <span class="o">=</span> <span class="nx">app</span><span class="p">(</span><span class="nx">EloquentFactory</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
  <span class="nv">$arguments</span> <span class="o">=</span> <span class="nb">func_get_args</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">of</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">times</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">??</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">of</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">times</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">of</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span></code></pre></figure> <p>Ok, next question: What is this <code class="highlighter-rouge">of</code> function called on the <code class="highlighter-rouge">EloquentFactory</code>? Well, it uses another class called <code class="highlighter-rouge">FactoryBuilder</code> where we pass along the name of the class we want to create from the factory.</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">of</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">FactoryBuilder</span><span class="p">(</span>
    <span class="nv">$class</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">definitions</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">states</span><span class="p">,</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">afterMaking</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">afterCreating</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">faker</span>
  <span class="p">);</span>
<span class="p">}</span></code></pre></figure> <p>Digging more into the <code class="highlighter-rouge">FactoryBuilder</code> code, I traced the commonly used <code class="highlighter-rouge">create</code> and <code class="highlighter-rouge">make</code> functions to a function called <code class="highlighter-rouge">makeInstance</code>. Here‚Äôs what <code class="highlighter-rouge">makeInstance</code> looks like:</p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">makeInstance</span><span class="p">(</span><span class="k">array</span> <span class="nv">$attributes</span> <span class="o">=</span> <span class="p">[])</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="nx">Model</span><span class="o">::</span><span class="na">unguarded</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$attributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">class</span><span class="p">(</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRawAttributes</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$instance</span><span class="o">-&gt;</span><span class="na">setConnection</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$instance</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure> <p>Ah, finally we find the factory pattern with some meta-programming involved. In the contructor of the object, we passed in the class name and stored it to <code class="highlighter-rouge">$this-&gt;class</code>. PHP allows you to hold the names of class, function, and variables in another variable to be used later. In the example here, we see that the string held in <code class="highlighter-rouge">$this-&gt;class</code> is used to instantiate a new object by simply doing <code class="highlighter-rouge">new $this-&gt;class()</code>. Whoa.</p> <p>Well, hopefully that gave you some insight into what the factory pattern is and how it‚Äôs used in Laravel‚Äôs factories to help you create instances of Eloquent models. Until next time, happy coding!</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2018 All rights reserved. Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/nandomoreirame/dotX" target="_blank">dotX</a> theme.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html>