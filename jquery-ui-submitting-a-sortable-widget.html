<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>JQuery UI: Submitting a Sortable Widget</title> <meta name="description" content="JQuery UI has a great widget called Sortable, where you can drag and drop items in place to… you guessed it, it sorts the items. This is great and all, but o..."> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://snags88.github.io/jquery-ui-submitting-a-sortable-widget"> <link rel="alternate" type="application/rss+xml" title="gem install Seiji" href="http://snags88.github.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="no-style primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i> LinkedIn</a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">JQuery UI: Submitting a Sortable Widget</h1> <p class="post-meta"><time datetime="2015-06-02T01:14:00-07:00" itemprop="datePublished">Jun 2, 2015</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <p>JQuery UI has a great widget called Sortable, where you can drag and drop items in place to… you guessed it, it sorts the items. This is great and all, but one of the reasons you may want to have this interactive UI is to reorder some list the user owns. In this post, we’ll take a look at one implementation of persisting newly sorted items in order to the database. This method will not use AJAX to submit the form.</p> <p>If you want to follow along, go ahead and fork <a href="http://github.com/snags88/sortable-form">this Github repo</a>. I’ve created branches for the major checkpoints.</p> <h3 id="setup">Setup</h3> <p>Let’s pretend that we’re making a photo album application, where we have photos that belong to an album. We want to show the photos in a particular order so when we edit the album, we should be able to use the Sortable widget and submit a form to persist the new order into the database.</p> <p>I’ve set up the bare-bones configuration before we actually start implementing the Sortable widget. This can be found on the GitHub repo as branch “1_base_config”. It’s a very standard Rails MVC setup except for that photo is a nested resource under album. As a result, in order to create any photos, you must create an album first, then add photos. I recommend forking, running the rails server, and test out the flow of the resources.</p> <h3 id="beforecreate-hooks">Before_create hooks</h3> <p>Note that we have an order attribute and a token attribute on the Photo model. The order is somewhat self-explanatory, but we’ll see soon why we need the token attribute. Both of these fields should be auto generated by the system when the photo is created.</p> <p>First, open up the model folder and find the Photo.rb file. We’re going to create 2 private methods that will automatically generate the order and token on the “before create” hook.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Photo.rb</span>
<span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:album</span>
  <span class="n">before_create</span> <span class="ss">:generate_token</span><span class="p">,</span> <span class="ss">:generate_order</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">generate_token</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">token</span> <span class="o">=</span> <span class="kp">loop</span> <span class="k">do</span>
        <span class="n">random_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">urlsafe_base64</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
        <span class="k">break</span> <span class="n">random_token</span> <span class="k">unless</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="ss">token: </span><span class="n">random_token</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">generate_order</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">order</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="ss">:order</span><span class="p">)</span> <span class="p">?</span> <span class="no">Product</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="ss">:order</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>In general, these methods should be broken out to different concerns so that it’s reusable across model, but we’ll save that for another blog post. You can test out that these hooks are working by starting the Rails server and creating some photos.</p> <h3 id="sortable-widget">Sortable Widget</h3> <p>The next step is to implement the sortable widget. For this example, we’ll use just the photo description, but you can imagine that the actual image could be used as part of the UI. Additionally, as part of the configuration, the JQuery UI library has already been included in the vendor/assets folder and the application.</p> <p>First, setup a list item of all the album photos in <strong>views/albums/edit.html.erb</strong>. In order to turn it into a Sortable widget, make sure that the &lt;ol&gt; tag has an id of “sortable”.</p> <figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="nt">&lt;ol</span> <span class="na">id=</span><span class="s">"sortable"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%-</span> <span class="vi">@album</span><span class="p">.</span><span class="nf">photos</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">photo</span><span class="o">|</span> <span class="cp">-%&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">photo</span><span class="p">.</span><span class="nf">description</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%-</span> <span class="k">end</span> <span class="cp">-%&gt;</span>
<span class="nt">&lt;/ol&gt;</span></code></pre></figure> <p>Then in the empty <strong>app/assets/javascripts/sortable.js</strong>, call the JQuery UI sortable function on the unordered list element.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#sortable'</span><span class="p">).</span><span class="nx">sortable</span><span class="p">();</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"#sortable"</span><span class="p">).</span><span class="nx">disableSelection</span><span class="p">();</span>
<span class="p">})</span></code></pre></figure> <p>Now, if you access the Edit Order page, the list items should be sortable by dragging and dropping the items.</p> <h3 id="submit-and-persist-the-sortable-widget">Submit and persist the Sortable widget</h3> <p>The final step is to wrap a form around the sortable widget and submit the information. Let’s start by modifying the <strong>edit.html.erb</strong> view.</p> <figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@album</span><span class="p">,</span> <span class="ss">:html</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">id: </span><span class="s2">"sortForm"</span><span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
   <span class="nt">&lt;ol</span> <span class="na">id=</span><span class="s">"sortable"</span><span class="nt">&gt;</span>
     <span class="cp">&lt;%-</span> <span class="vi">@album</span><span class="p">.</span><span class="nf">photos</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">photo</span><span class="o">|</span> <span class="cp">-%&gt;</span>
       <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"ui-state-default"</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">photo</span><span class="p">.</span><span class="nf">token</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">photo</span><span class="p">.</span><span class="nf">description</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
     <span class="cp">&lt;%-</span> <span class="k">end</span> <span class="cp">-%&gt;</span>
   <span class="nt">&lt;/ol&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"photo[tokens]"</span> <span class="na">id=</span><span class="s">"newOrder"</span><span class="nt">&gt;</span>
   <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Save"</span> <span class="cp">%&gt;</span>
 <span class="cp">&lt;%-</span> <span class="k">end</span> <span class="cp">-%&gt;</span></code></pre></figure> <p>In the above code, we’ve added a <code class="highlighter-rouge">form_for</code> for the album and added some required markup on the <code class="highlighter-rouge">form_for</code> and the <code class="highlighter-rouge">li</code> tag. It is important to note that the id attribute of the <code class="highlighter-rouge">li</code> tag is the randomly generated token. This way, we don’t expose the database IDs of the photo to the users. Lastly, there is an text input field. This will be populated by the order of the photos before the form is submitted using the Javascript code presented below from the <strong>sortable.js</strong> file:</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#sortable'</span><span class="p">).</span><span class="nx">sortable</span><span class="p">();</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#sortable'</span><span class="p">).</span><span class="nx">disableSelection</span><span class="p">();</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#sortForm'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'submit'</span><span class="p">,</span> <span class="nx">photoSorter</span><span class="p">.</span><span class="nx">submit</span><span class="p">)</span>
<span class="p">})</span>

<span class="kd">var</span> <span class="nx">photoSorter</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">submit</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">"#newOrder"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">"#sortable"</span><span class="p">).</span><span class="nx">sortable</span><span class="p">(</span><span class="s2">"toArray"</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>The photoSorter.submit function will take the ID attributes from the sortable elements and covert it into an array. Afterwards, it will populate the value of the text field with the array. Once the form is submitted, params should look similar to the following:</p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">params</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nt">"photo"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">{</span><span class="nt">"tokens"</span><span class="err">=&gt;</span><span class="nt">"YF-9earkp7vBrKSM3n5U5w,
                         PvljlQZBSC0UcUrg_DxBaw,
                         t8Pg_fR_j69SqKSiEjt4WQ"</span><span class="err">}</span><span class="w">
</span><span class="err">}</span></code></pre></figure> <p>In the Album Controller, we need to make a few modifications. We first need to use strong params to sanitize the tokens and then on the update action, call <code class="highlighter-rouge">Album#update_order</code> and pass in the order params. We should also implement the <code class="highlighter-rouge">Album#update_order</code> method on the Album model:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># albums_controller.rb</span>
<span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">def</span> <span class="n">update</span>
    <span class="vi">@album</span><span class="p">.</span><span class="nf">update_order</span><span class="p">(</span><span class="n">order_params</span><span class="p">[</span><span class="ss">:tokens</span><span class="p">])</span>
    <span class="n">redirect_to</span> <span class="vi">@album</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">def</span> <span class="n">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:photo</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:tokens</span><span class="p">)</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>

<span class="c1"># album.rb</span>
<span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">def</span> <span class="n">update_order</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">tokens</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">','</span><span class="p">).</span><span class="nf">each</span><span class="p">.</span><span class="nf">with_index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">token</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
      <span class="n">photo</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">photos</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">token: </span><span class="n">token</span><span class="p">)</span>
      <span class="n">photo</span><span class="p">.</span><span class="nf">order</span> <span class="o">=</span> <span class="n">index</span>
      <span class="n">photo</span><span class="p">.</span><span class="nf">save</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span></code></pre></figure> <p>The methods can be refactored some and abstracted out to a PhotoSorter class, but for the sake of this example, we’ll keep it as is. Now if you take a look at the album page, the photos have a new order in the Order column. As a final touch you can hide the text input field on the “Edit Photo Order” page so it is hidden from the users. The final product can be found in the “master” branch or the “3_persist_order”.</p> <p>Another implementation of using the Sortable widget with a form can be achieved by using AJAX to send the information. We’ll save that for another blog post. Until next time happy coding!</p> <p>Reference: <a href="http://stackoverflow.com/questions/5131460/using-jqueryui-sortable-list-with-forms">http://stackoverflow.com/questions/5131460/using-jqueryui-sortable-list-with-forms</a></p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/snags88" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/in/snaganuma" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/S2k10" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2018 All rights reserved. Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/nandomoreirame/dotX" target="_blank">dotX</a> theme.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html>